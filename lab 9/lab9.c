/* Lab 9 - Game and EEPROM */

#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include <avr/eeprom.h>
#include "Nokia5110.h"
#include <stdint.h>            // has to be added to use uint8_t




// *************************** Images ***************************
// enemy ship that starts at the top of the screen (arms/mouth closed)
// width=16 x height=10
const unsigned char SmallEnemy[] = {
    0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0x0F, 0xF0, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF
};


// a missile in flight
// includes one blacked out row on the top, bottom, and right of the image to prevent smearing when moved 1 pixel down, up, or left
// width=4 x height=9
const unsigned char MissileImg[] = {
    0x42, 0x4D, 0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00,
    0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF
};

// small explosion best used for the demise of an enemy
// width=16 x height=10
const unsigned char SmallExplosion[] = {
    0x42, 0x4D, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0,
    0x0F, 0x00, 0x0F, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0xF0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
    0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF
};

// image of the player's ship
// includes two blacked out columns on the left and right sides of the image to prevent smearing when moved 2 pixels to the left or right
// width=18 x height=8
const unsigned char PlayerShip[] = {
    0x42, 0x4D, 0xD6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0xC4, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xAA, 0xAA, 0xAA,
    0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xAA, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF
};


struct State {
    unsigned long x;      // x coordinate
    unsigned long y;      // y coordinate
    const unsigned char *image; // pointer to images
    long life;            // 0=dead, 1=alive
};

typedef struct State STyp;
const uint8_t NUM_ENEMIES = 4;

STyp Enemy[4];
STyp Player;
STyp Missile;

uint8_t gameState;

uint8_t enemyAlive[4];
uint8_t enemiesAlive;
uint8_t missleReady;

uint16_t enemies_y = 10;
volatile uint8_t all_buttons;

void mydelay_ms(uint16_t count);


#define MISSILE_SPEED 5

// Atmega328 interrupts
// https://sites.google.com/site/qeewiki/books/avr-guide/external-interrupts-on-the-atmega328
void initGame() {
    for (uint8_t i; i < NUM_ENEMIES; i ++) {
        Enemy[i].x = i * 16;
        Enemy[i].y = enemies_y;
        Enemy[i].image = SmallEnemy;
        enemyAlive[i] = 1;
    }
    Player.x = 20;
    Player.y = 47;
    Player.image = PlayerShip;
    Missile.x = 100;
    Missile.y = 100;
    Missile.image = MissileImg;
    missleReady = 1;

    gameState = 0;
    enemiesAlive = NUM_ENEMIES;
}

void drawGame() {

    for (uint8_t i = 0; i < NUM_ENEMIES; i ++) {
        if (enemyAlive[i] == 1)
            Nokia5110_PrintBMP(Enemy[i].x, Enemy[i].y, Enemy[i].image, 1);
        else if (enemyAlive[i] == 2) {
            Nokia5110_PrintBMP(Enemy[i].x, Enemy[i].y, SmallExplosion, 1);
            enemyAlive[i] = 0;
        }
    }
    Nokia5110_PrintBMP(Player.x, Player.y, Player.image, 1);
    if (! missleReady)
        Nokia5110_PrintBMP(Missile.x, Missile.y, Missile.image, 1);
}

void advanceGame() {
    // ========== Enemies ==========
    enemies_y += 1;
    for (uint8_t i = 0; i < NUM_ENEMIES; i ++) {
        Enemy[i].y = enemies_y / 2;
    }
    // Enemy[1].y = 10;
    // ========== Player ==========
    int speed = 4;
    if ((~all_buttons) & (1 << DDB2)) {
        Player.x += speed;
        if (Player.x > 66) {
            Player.x = 0;
        }
    }
    else if ((~all_buttons) & (1 << DDB3)) {
        if (missleReady) {
            missleReady = 0;
            Missile.x = Player.x + 8;
            Missile.y = Player.y;
        }
    }
    else if ((~all_buttons) & (1 << DDB4)) {
        if (Player.x < speed || Player.x == 0) {
            Player.x = 66;

        }
        else {
            Player.x -= speed;
        }

    }
    if (Missile.y > 10) {
        Missile.y -= MISSILE_SPEED;
        for (int i = 0; i < NUM_ENEMIES; i++) {
            if (enemyAlive[i]) {
                int diff = (Missile.x + 2) - (Enemy[i].x + 8);
                if (diff < 0) {
                    diff = -diff;
                }
                if (Missile.y < Enemy[i].y && diff < 8) {
                    enemyAlive[i] = 2;
                    missleReady = 1;
                    enemiesAlive -= 1;
                }
            }
        }
    } else {
        missleReady = 1;
    }
    if (gameState == 0 && Enemy[0].y > Player.y) {
        gameState = 2;
    } else if (gameState == 0 && enemiesAlive == 0) {
        gameState = 1;
    }
    // Player.x = Player.x % 66;
    // if (Player.x < speed) {
    //  Player.x = 0;
    // }
    // else if (Player.x > 66) {
    //  Player.x = 66;
    // }
}

void initButtonPins() {
    // Set B pins to input
    DDRD = 0x00;

    // Enable pull-up resistors
    PORTD |= (1 << DDB2);
    PORTD |= (1 << DDB3);
    PORTD |= (1 << DDB4);
}

void initButtonInterrupt() {
    // EIMSK |= (1 << INT2);
    // EICRA &= 0b0000;
    PCICR |= (1 << PCIE2);    // set PCIE2 to enable PCMSK0 scan
    PCMSK2 |= (1 << PCINT18);
    PCMSK2 |= (1 << PCINT19);
    PCMSK2 |= (1 << PCINT20);
    sei();    // Enable interrupts
}


int main() {
    all_buttons = 0xFF;

    initButtonPins();
    initButtonInterrupt();

    nokia_lcd_init();
    nokia_lcd_clear();
    // nokia_lcd_fill();
    Nokia5110_OutString("lcd is alive");
    nokia_lcd_render();

    initGame();

    while (1) {
        advanceGame();
        // ========== Prepare the LCD ==========
        Nokia5110_ClearBuffer();
        Nokia5110_Clear();

        // ========== Draw the game object sprites ==========

        drawGame();
        nokia_lcd_render();


        char out[10] = {0};
        sprintf(out, "%d", Player.x);
        Nokia5110_OutString(out);

        // nokia_lcd_render();
        // button ++;
        // drawGame();

        mydelay_ms(500);

    }
}


ISR(BADISR_vect) {
    all_buttons = PIND;
}


void mydelay_ms(uint16_t count) {
    while (count--) {
        _delay_ms(1);
    }
}